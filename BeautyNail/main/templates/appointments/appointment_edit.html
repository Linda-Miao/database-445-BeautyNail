{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <div>
    <h2 class="text-center mb-4">Edit Appointment</h2>
    <form method="post">
      {% csrf_token %}
      <table>
        <tr>
          <td><label for="customer_id">Customer:</label></td>
          <td>
            <select id="customer_id" name="customer_id" required>
              <option value="">-- Select Customer --</option>
              {% for c in cust_opts %}
                <option value="{{ c.id }}" {% if c.id == appt.customer_id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <td><label for="staff_id">Staff:</label></td>
          <td>
            <select id="staff_id" name="staff_id" required>
              <option value="">-- Select Active Staff --</option>
              {% for s in staff_opts %}
                <option value="{{ s.id }}" {% if s.id == appt.staff_id %}selected{% endif %}>
                  {{ s.name }}{% if s.specialty %} — {{ s.specialty }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <td><label for="appointment_date">Date:</label></td>
          <td><input type="date" id="appointment_date" name="appointment_date" value="{{ appt.appointment_date|date:'Y-m-d' }}" required></td>
        </tr>
        <tr>
          <td><label for="start_time">Start Time:</label></td>
          <td><input type="time" id="start_time" name="start_time" value="{{ appt.start_time|time:'H:i' }}" required></td>
        </tr>
        <tr>
          <td><label for="end_time">End Time:</label></td>
          <td><input type="time" id="end_time" name="end_time" value="{{ appt.end_time|time:'H:i' }}"></td>
        </tr>
        <tr>
          <td><label for="status">Status:</label></td>
          <td>
           <select id="status" name="status">
            {% for s in status_choices %}
                <option value="{{ s }}" {% if appt.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
  <td valign="top"><label>Services:</label></td>
  <td>
    <div id="services-list">
      {% if current_services and current_services|length > 0 %}
        {% for row in current_services %}
          <div class="service-row mb-2">
            <select name="service_ids[]" class="form-select d-inline-block" style="width: 320px;">
              <option value="">-- Select Service --</option>
              {% for s in svc_opts %}
                <option value="{{ s.id }}" {% if s.id == row.service_id %}selected{% endif %}>
                  {{ s.name }} (${{ s.price }})
                </option>
              {% endfor %}
            </select>
            <input type="text" name="polish_colors[]" class="form-control d-inline-block ms-2" style="width:180px;"
                   placeholder="Polish color (optional)" value="{{ row.color|default:'' }}">
            <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="addServiceRow()">+</button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-1" onclick="removeServiceRow(this)">−</button>
          </div>
        {% endfor %}
      {% else %}
        <!-- if no existing services, render one blank row -->
        <div class="service-row mb-2">
          <select name="service_ids[]" class="form-select d-inline-block" style="width: 320px;">
            <option value="">-- Select Service --</option>
            {% for s in svc_opts %}
              <option value="{{ s.id }}">{{ s.name }} (${{ s.price }})</option>
            {% endfor %}
          </select>
          <input type="text" name="polish_colors[]" class="form-control d-inline-block ms-2" style="width:180px;"
                 placeholder="Polish color (optional)">
          <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="addServiceRow()">+</button>
          <button type="button" class="btn btn-outline-secondary btn-sm ms-1" onclick="removeServiceRow(this)">−</button>
        </div>
      {% endif %}
    </div>
  </td>
</tr>
        <tr>
          <td><label for="notes">Notes:</label></td>
          <td><textarea id="notes" name="notes" rows="3" cols="40">{{ appt.notes }}</textarea></td>
        </tr>
        <tr>
          <td colspan="2" style="text-align:center; padding-top:12px;">
            <button type="submit" class="btn btn-success me-2">Update</button>
            <a href="{% url 'appointment_list' %}" class="btn btn-secondary">Cancel</a>
          </td>
        </tr>
      </table>
    </form>
  </div>
</div>

{% comment %} <script>
function addServiceRow() {
  const container = document.getElementById('services-list');
  const first = container.querySelector('.service-row');
  const clone = first.cloneNode(true);

  // reset fields in the new row
  const sel = clone.querySelector('select[name="service_ids[]"]');
  if (sel) sel.value = "";
  const colorInput = clone.querySelector('input[name="polish_colors[]"]');
  if (colorInput) colorInput.value = "";

  container.appendChild(clone);
}
function removeServiceRow(btn) {
  const container = document.getElementById('services-list');
  const rows = container.querySelectorAll('.service-row');
  if (rows.length > 1) {
    btn.closest('.service-row').remove();
  }
}
</script> {% endcomment %}
{% load static %}
<script src="{% static 'js/appointments.js' %}" defer></script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <div>
    <h2 class="text-center mb-4">Edit Appointment</h2>
    <form method="post">
      {% csrf_token %}
      <table>
        <tr>
          <td><label for="customer_id">Customer:</label></td>
          <td>
            <select id="customer_id" name="customer_id" required>
              <option value="">-- Select Customer --</option>
              {% for c in cust_opts %}
              <option value="{{ c.id }}" {% if c.id == appt.customer_id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>

        <tr>
          <td><label for="staff_id">Staff:</label></td>
          <td>
            <select id="staff_id" name="staff_id" required>
              <option value="">-- Select Active Staff --</option>
              {% for s in staff_opts %}
              <option value="{{ s.id }}" {% if s.id == appt.staff_id %}selected{% endif %}>
                {{ s.name }}{% if s.specialty %} — {{ s.specialty }}{% endif %}
              </option>
              {% endfor %}
            </select>
          </td>
        </tr>

        <tr>
          <td><label>Appointment Date & Time:</label></td>
          <td>
            <div class="calendar-section bg-white rounded-4 p-4 shadow-sm" style="max-width: 500px;">
              <h3 class="calendar-title h5 mb-3">Pick a date & time</h3>

              <!-- DATE -->
              <div id="inline_date" data-selected-date="{{ appt.appointment_date|date:'Y-m-d' }}"></div>

              <!-- Hidden fields -->
              <input type="hidden" id="appointment_date" name="appointment_date" value="{{ appt.appointment_date|date:'Y-m-d' }}" required>
              <input type="hidden" id="start_time" name="start_time" value="{{ selected_time }}" required>

              <!-- TIME GRID -->
              <div class="mt-4">
                <h6 class="mb-3">Available Times</h6>
                <div id="time_grid" class="row g-3" data-selected-time="{{ selected_time }}">
                  {% for time_val, time_label in time_slots %}
                  <div class="col-4">
                    <button type="button"
                            class="btn btn-light w-100 time-slot-btn{% if selected_time == time_val %} selected-slot{% endif %}"
                            data-time="{{ time_val }}">
                      {{ time_label }}
                    </button>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </td>
        </tr>

        <tr>
          <td><label for="status">Status:</label></td>
          <td>
            <select id="status" name="status">
              {% for s in status_choices %}
              <option value="{{ s }}" {% if appt.status == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>

        <!-- Services + Notes unchanged -->
<td valign="top"><label>Services:</label></td>
  <td>
    <div id="services-list">
      {% if current_services and current_services|length > 0 %}
        {% for row in current_services %}
        <div class="service-row mb-2">
          <select name="service_ids[]" class="form-select d-inline-block service-select" style="width: 320px;">
            <option value="">-- Select Service --</option>
            {% for s in svc_opts %}
              {% with sid=s.id|stringformat:"s" cur=row.service_id|stringformat:"s" %}
              <option value="{{ s.id }}"
                      data-duration="{{ s.dur|default:0 }}"
                      data-price="{{ s.price }}"
                      {% if sid == cur %}selected{% endif %}>
                {{ s.name }} (${{ s.price }}){% if s.dur %} — {{ s.dur }} min{% endif %}
              </option>
              {% endwith %}
            {% endfor %}
            <option value="unsure">Not sure yet — I'll decide during consultation</option>
          </select>

          <input type="text"
                 name="polish_colors[]"
                 class="form-control d-inline-block ms-2 service-color"
                 style="width:180px;"
                 placeholder="Polish color (optional)"
                 value="{{ row.color|default:'' }}">

          <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="addServiceRow()">+</button>
          <button type="button" class="btn btn-outline-secondary btn-sm ms-1" onclick="removeServiceRow(this)">−</button>
        </div>
        {% endfor %}
      {% else %}
        {# Fallback: one empty row #}
        <div class="service-row mb-2">
          <select name="service_ids[]" class="form-select d-inline-block service-select" style="width: 320px;">
            <option value="">-- Select Service --</option>
            {% for s in svc_opts %}
              <option value="{{ s.id }}"
                      data-duration="{{ s.dur|default:0 }}"
                      data-price="{{ s.price }}">
                {{ s.name }} (${{ s.price }}){% if s.dur %} — {{ s.dur }} min{% endif %}
              </option>
            {% endfor %}
            <option value="unsure">Not sure yet — I'll decide during consultation</option>
          
                  </select>
                  <input type="text" name="polish_colors[]" class="form-control d-inline-block ms-2" style="width:180px;" placeholder="Polish color (optional)">
                  <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="addServiceRow()">+</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm ms-1" onclick="removeServiceRow(this)">−</button>
                </div>
              {% endif %}
            </div>
          </td>
        </tr>

        <tr>
          <td><label for="notes">Notes:</label></td>
          <td><textarea id="notes" name="notes" rows="3" cols="40">{{ appt.notes }}</textarea></td>
        </tr>

        <tr>
          <td colspan="2" style="text-align:center; padding-top:12px;">
            <button type="submit" class="btn btn-success me-2">Update</button>
            <a href="{% url 'appointment_list' %}" class="btn btn-secondary">Cancel</a>
          </td>
        </tr>
      </table>
    </form>
  </div>
</div>

<script src="{% static 'js/appointments.js' %}?v=23" defer></script>
{% endblock %}
